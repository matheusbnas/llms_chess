<!-- ♟️ Play Page -->
<div class="text-center mb-24">
    <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">
        <i class="fas fa-gamepad" style="color: var(--lichess-brown-light);"></i>
        Jogar contra IA
    </h1>
    <p style="color: var(--text-secondary); font-size: 16px;">
        Desafie um modelo de IA em uma partida de xadrez profissional
    </p>
</div>

<!-- Game Layout -->
<div class="d-grid" style="grid-template-columns: 300px 1fr 300px; gap: 24px; align-items: start;">
    
    <!-- Left Sidebar - Game Configuration -->
    <div class="d-flex" style="flex-direction: column; gap: 16px;">
        <!-- Game Setup -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-cog"></i>
                    Nova Partida
                </h3>
            </div>
            
            <div class="form-group">
                <label class="form-label">Oponente IA</label>
                <select class="form-control" id="opponent-model">
                    <option value="GPT-4o">GPT-4o (Mais Forte)</option>
                    <option value="GPT-4-Turbo">GPT-4-Turbo (Equilibrado)</option>
                    <option value="Gemini-Pro" selected>Gemini-Pro (Criativo)</option>
                    <option value="Claude-3.5-Sonnet">Claude-3.5 (Estratégico)</option>
                    <option value="Deepseek-R1">Deepseek-R1 (Experimental)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Sua Cor</label>
                <div class="d-flex gap-8">
                    <label class="form-check" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer;">
                        <input type="radio" name="player-color" value="white" checked>
                        <span style="font-size: 16px;">♔</span>
                        <span class="form-check-label">Brancas</span>
                    </label>
                    <label class="form-check" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer;">
                        <input type="radio" name="player-color" value="black">
                        <span style="font-size: 16px;">♚</span>
                        <span class="form-check-label">Pretas</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Dificuldade</label>
                <select class="form-control" id="difficulty">
                    <option value="beginner">Iniciante (1200)</option>
                    <option value="intermediate">Intermediário (1400)</option>
                    <option value="advanced" selected>Avançado (1600)</option>
                    <option value="expert">Expert (1800)</option>
                    <option value="master">Mestre (2000+)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Controle de Tempo</label>
                <select class="form-control" id="time-control">
                    <option value="unlimited">Sem limite</option>
                    <option value="bullet">Bullet (1+0)</option>
                    <option value="blitz" selected>Blitz (5+3)</option>
                    <option value="rapid">Rapid (15+10)</option>
                    <option value="classical">Classical (30+0)</option>
                </select>
            </div>

            <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;" data-action="start-human-game">
                <i class="fas fa-play"></i>
                Iniciar Partida
            </button>
        </div>

        <!-- Game Controls -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tools"></i>
                    Controles
                </h3>
            </div>
            
            <div class="d-flex" style="flex-direction: column; gap: 8px;">
                <button class="btn btn-secondary" style="justify-content: center;" disabled>
                    <i class="fas fa-lightbulb"></i>
                    Solicitar Dica
                </button>
                <button class="btn btn-secondary" style="justify-content: center;" disabled>
                    <i class="fas fa-undo"></i>
                    Desfazer Lance
                </button>
                <button class="btn btn-warning" style="justify-content: center;" disabled>
                    <i class="fas fa-handshake"></i>
                    Oferecer Empate
                </button>
                <button class="btn btn-danger" style="justify-content: center;" disabled>
                    <i class="fas fa-flag"></i>
                    Resignar
                </button>
            </div>
        </div>
    </div>

    <!-- Center - Game Board -->
    <div class="d-flex" style="flex-direction: column; align-items: center; gap: 16px;">
        <!-- Game Status -->
        <div id="game-status" class="game-status status-playing" style="width: 100%;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                <i class="fas fa-info-circle"></i>
                Configure uma nova partida para começar
            </div>
            <div style="color: var(--text-secondary); font-size: 14px;">
                Selecione seu oponente e configurações acima
            </div>
        </div>
        
        <!-- Chess Board Container -->
        <div id="play-chessboard-container" class="chessboard-container" style="position: relative;">
            <!-- Coordenadas externas -->
            <div class="coordinates-external coord-files-top">
                <div class="coord-label">a</div>
                <div class="coord-label">b</div>
                <div class="coord-label">c</div>
                <div class="coord-label">d</div>
                <div class="coord-label">e</div>
                <div class="coord-label">f</div>
                <div class="coord-label">g</div>
                <div class="coord-label">h</div>
            </div>
            
            <div class="coordinates-external coord-ranks-left">
                <div class="coord-label">8</div>
                <div class="coord-label">7</div>
                <div class="coord-label">6</div>
                <div class="coord-label">5</div>
                <div class="coord-label">4</div>
                <div class="coord-label">3</div>
                <div class="coord-label">2</div>
                <div class="coord-label">1</div>
            </div>
            
            <!-- Tabuleiro principal -->
            <div class="chessboard" id="play-chessboard">
                <!-- As 64 casas serão geradas por JavaScript -->
            </div>
            
            <div class="coordinates-external coord-ranks-right">
                <div class="coord-label">8</div>
                <div class="coord-label">7</div>
                <div class="coord-label">6</div>
                <div class="coord-label">5</div>
                <div class="coord-label">4</div>
                <div class="coord-label">3</div>
                <div class="coord-label">2</div>
                <div class="coord-label">1</div>
            </div>
            
            <div class="coordinates-external coord-files-bottom">
                <div class="coord-label">a</div>
                <div class="coord-label">b</div>
                <div class="coord-label">c</div>
                <div class="coord-label">d</div>
                <div class="coord-label">e</div>
                <div class="coord-label">f</div>
                <div class="coord-label">g</div>
                <div class="coord-label">h</div>
            </div>
        </div>

        <!-- Board Controls -->
        <div class="board-controls" id="board-controls" style="display: none;">
            <button class="control-btn" title="Primeiro lance" data-move="first">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-btn" title="Lance anterior" data-move="previous">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="control-btn" title="Próximo lance" data-move="next">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="control-btn" title="Último lance" data-move="last">
                <i class="fas fa-step-forward"></i>
            </button>
            <button class="control-btn" title="Virar tabuleiro" data-action="flip">
                <i class="fas fa-refresh"></i>
            </button>
        </div>
    </div>

    <!-- Right Sidebar - Game Info -->
    <div class="d-flex" style="flex-direction: column; gap: 16px;">
        <!-- Player Info -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i>
                    Jogadores
                </h3>
            </div>
            
            <div style="margin-bottom: 16px;">
                <div class="d-flex align-center gap-12">
                    <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">Você</div>
                        <div style="color: var(--text-secondary); font-size: 12px;" id="player-color-display">Brancas</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 600;" id="player-rating">1600</div>
                        <div style="color: var(--text-secondary); font-size: 10px;">Rating</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 12px 0; color: var(--text-muted); font-weight: 600;">VS</div>
            
            <div>
                <div class="d-flex align-center gap-12">
                    <div style="width: 40px; height: 40px; background: var(--lichess-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;" id="ai-model-display">Gemini-Pro</div>
                        <div style="color: var(--text-secondary); font-size: 12px;" id="ai-color-display">Pretas</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 600;" id="ai-rating">1750</div>
                        <div style="color: var(--text-secondary); font-size: 10px;">Rating</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clock -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clock"></i>
                    Tempo
                </h3>
                <span class="badge badge-secondary" id="time-control-display">Blitz 5+3</span>
            </div>
            
            <div class="d-flex justify-between align-center">
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 24px; font-weight: 700; font-family: var(--font-mono); color: var(--lichess-green);" id="player-time">5:00</div>
                    <div style="color: var(--text-secondary); font-size: 12px;">Você</div>
                </div>
                <div style="color: var(--text-muted); font-size: 20px;">:</div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 24px; font-weight: 700; font-family: var(--font-mono); color: var(--text-muted);" id="ai-time">5:00</div>
                    <div style="color: var(--text-secondary); font-size: 12px;">IA</div>
                </div>
            </div>
        </div>

        <!-- Move History -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i>
                    Lances
                </h3>
                <button class="btn btn-sm btn-secondary">
                    <i class="fas fa-download"></i>
                    PGN
                </button>
            </div>
            
            <div id="move-history" style="max-height: 200px; overflow-y: auto; font-family: var(--font-mono); font-size: 13px;">
                <div style="color: var(--text-muted); text-align: center; padding: 20px; font-style: italic;">
                    Nenhuma partida em andamento
                </div>
            </div>
        </div>

        <!-- Analysis -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Análise
                </h3>
                <span class="badge badge-success">Stockfish 15</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 20px; height: 80px; background: linear-gradient(to top, #2c2c2c 50%, #eeeeee 50%); border: 1px solid var(--border-color); border-radius: 3px; position: relative;">
                    <div style="position: absolute; width: 100%; height: 3px; background: var(--lichess-blue); top: 50%; transform: translateY(-50%); border-radius: 1px;"></div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);" id="evaluation">+0.0</div>
                    <div style="color: var(--text-secondary); font-size: 12px;">Avaliação</div>
                </div>
            </div>
            
            <div style="font-size: 12px; color: var(--text-secondary);">
                <div>Melhor lance: <span style="font-family: var(--font-mono); color: var(--text-primary);" id="best-move">-</span></div>
                <div>Profundidade: <span id="engine-depth">-</span></div>
            </div>
        </div>
    </div>
</div>

<!-- Game Result Modal (Hidden by default) -->
<div id="game-result-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-flag-checkered"></i>
                Fim de Partida
            </h2>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;" id="result-icon">🏆</div>
                <h3 id="result-text">Você venceu!</h3>
                <p style="color: var(--text-secondary);" id="result-reason">Por xeque-mate</p>
            </div>
            
            <div class="d-grid" style="grid-template-columns: 1fr 1fr; gap: 16px; text-align: center;">
                <div>
                    <div style="font-size: 20px; font-weight: 700;">42</div>
                    <div style="color: var(--text-secondary); font-size: 12px;">Lances</div>
                </div>
                <div>
                    <div style="font-size: 20px; font-weight: 700;">12m 34s</div>
                    <div style="color: var(--text-secondary); font-size: 12px;">Duração</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeGameResultModal()">Fechar</button>
            <button class="btn btn-primary" onclick="startNewGame()">Nova Partida</button>
        </div>
    </div>
</div>

<script>
// Play page JavaScript
class ProfessionalChessboard {
    constructor(containerId) {
        this.board = document.getElementById(containerId);
        this.selectedSquare = null;
        this.isFlipped = false;
        this.gamePosition = this.getInitialPosition();
        
        this.initializeBoard();
        this.setupInitialPosition();
        this.addEventListeners();
    }

    getInitialPosition() {
        return {
            'a8': { piece: '♜', color: 'black' }, 'b8': { piece: '♞', color: 'black' }, 'c8': { piece: '♝', color: 'black' }, 'd8': { piece: '♛', color: 'black' },
            'e8': { piece: '♚', color: 'black' }, 'f8': { piece: '♝', color: 'black' }, 'g8': { piece: '♞', color: 'black' }, 'h8': { piece: '♜', color: 'black' },
            'a7': { piece: '♟', color: 'black' }, 'b7': { piece: '♟', color: 'black' }, 'c7': { piece: '♟', color: 'black' }, 'd7': { piece: '♟', color: 'black' },
            'e7': { piece: '♟', color: 'black' }, 'f7': { piece: '♟', color: 'black' }, 'g7': { piece: '♟', color: 'black' }, 'h7': { piece: '♟', color: 'black' },
            
            'a2': { piece: '♙', color: 'white' }, 'b2': { piece: '♙', color: 'white' }, 'c2': { piece: '♙', color: 'white' }, 'd2': { piece: '♙', color: 'white' },
            'e2': { piece: '♙', color: 'white' }, 'f2': { piece: '♙', color: 'white' }, 'g2': { piece: '♙', color: 'white' }, 'h2': { piece: '♙', color: 'white' },
            'a1': { piece: '♖', color: 'white' }, 'b1': { piece: '♘', color: 'white' }, 'c1': { piece: '♗', color: 'white' }, 'd1': { piece: '♕', color: 'white' },
            'e1': { piece: '♔', color: 'white' }, 'f1': { piece: '♗', color: 'white' }, 'g1': { piece: '♘', color: 'white' }, 'h1': { piece: '♖', color: 'white' }
        };
    }

    initializeBoard() {
        if (!this.board) return;
        
        this.board.innerHTML = '';
        
        for (let rank = 8; rank >= 1; rank--) {
            for (let file = 0; file < 8; file++) {
                const square = document.createElement('div');
                const fileChar = String.fromCharCode(97 + file); // a-h
                const squareId = `${fileChar}${rank}`;
                
                const isLight = (rank + file) % 2 !== 0;
                square.className = `square ${isLight ? 'light' : 'dark'}`;
                square.dataset.square = squareId;
                
                this.board.appendChild(square);
            }
        }
    }

    setupInitialPosition() {
        // Limpar todas as casas primeiro
        if (!this.board) return;
        
        document.querySelectorAll('.square').forEach(square => {
            square.innerHTML = '';
        });

        // Adicionar peças na posição inicial
        Object.entries(this.gamePosition).forEach(([square, pieceData]) => {
            this.placePiece(square, pieceData.piece, pieceData.color);
        });
    }

    placePiece(squareId, piece, color) {
        const square = document.querySelector(`[data-square="${squareId}"]`);
        if (!square) return;

        const pieceElement = document.createElement('div');
        pieceElement.className = `piece ${color}`;
        pieceElement.textContent = piece;
        pieceElement.dataset.piece = piece;
        pieceElement.dataset.color = color;
        pieceElement.draggable = true;
        
        square.appendChild(pieceElement);
    }

    addEventListeners() {
        if (!this.board) return;
        
        this.board.addEventListener('click', (e) => {
            const square = e.target.closest('.square');
            if (!square) return;

            this.handleSquareClick(square);
        });

        // Drag and drop
        this.board.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('piece')) {
                e.target.classList.add('dragging');
                this.selectedSquare = e.target.closest('.square');
            }
        });

        this.board.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('piece')) {
                e.target.classList.remove('dragging');
            }
        });

        this.board.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        this.board.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetSquare = e.target.closest('.square');
            if (targetSquare && this.selectedSquare) {
                this.attemptMove(this.selectedSquare, targetSquare);
            }
        });
    }

    handleSquareClick(square) {
        // Se já há uma casa selecionada, tentar fazer o movimento
        if (this.selectedSquare) {
            if (square === this.selectedSquare) {
                // Clicou na mesma casa - desselecionar
                this.clearSelection();
            } else {
                // Tentar fazer o movimento
                this.attemptMove(this.selectedSquare, square);
            }
        } else {
            // Selecionar casa se tiver peça
            const piece = square.querySelector('.piece');
            if (piece) {
                this.selectSquare(square);
            }
        }
    }

    selectSquare(square) {
        this.clearSelection();
        this.selectedSquare = square;
        square.classList.add('selected');
        
        // Mostrar movimentos possíveis (exemplo simples)
        this.showPossibleMoves(square);
    }

    showPossibleMoves(square) {
        // Exemplo simples - apenas demonstração visual
        const piece = square.querySelector('.piece');
        if (!piece) return;

        const squareId = square.dataset.square;
        const file = squareId.charCodeAt(0) - 97; // a=0, b=1, etc.
        const rank = parseInt(squareId[1]);

        // Exemplo para peões
        if (piece.dataset.piece === '♙' || piece.dataset.piece === '♟') {
            const direction = piece.dataset.color === 'white' ? 1 : -1;
            const targetRank = rank + direction;
            
            if (targetRank >= 1 && targetRank <= 8) {
                const targetSquare = String.fromCharCode(97 + file) + targetRank;
                const targetElement = document.querySelector(`[data-square="${targetSquare}"]`);
                if (targetElement && !targetElement.querySelector('.piece')) {
                    targetElement.classList.add('possible-move');
                }
            }
        }
    }

    attemptMove(fromSquare, toSquare) {
        const piece = fromSquare.querySelector('.piece');
        if (!piece) {
            this.clearSelection();
            return;
        }

        // Verificar se há peça no destino
        const targetPiece = toSquare.querySelector('.piece');
        const isCapture = targetPiece !== null;

        // Animação simples de movimento
        piece.classList.add('moving');

        setTimeout(() => {
            // Remover peça capturada
            if (isCapture) {
                targetPiece.classList.add('captured');
                setTimeout(() => targetPiece.remove(), 300);
            }

            // Mover peça
            toSquare.appendChild(piece);
            piece.classList.remove('moving');

            // Atualizar posição interna
            const pieceData = { 
                piece: piece.dataset.piece, 
                color: piece.dataset.color 
            };
            delete this.gamePosition[fromSquare.dataset.square];
            this.gamePosition[toSquare.dataset.square] = pieceData;

            this.clearSelection();
            
            // Notificar sobre o movimento
            if (typeof this.onMove === 'function') {
                this.onMove({
                    from: fromSquare.dataset.square,
                    to: toSquare.dataset.square,
                    piece: piece.dataset.piece,
                    color: piece.dataset.color,
                    isCapture: isCapture
                });
            }
        }, 250);
    }

    clearSelection() {
        if (this.selectedSquare) {
            this.selectedSquare.classList.remove('selected');
            this.selectedSquare = null;
        }

        // Limpar indicadores de movimento possível
        document.querySelectorAll('.possible-move, .possible-capture').forEach(square => {
            square.classList.remove('possible-move', 'possible-capture');
        });
    }

    flip() {
        this.isFlipped = !this.isFlipped;
        this.board.style.transform = this.isFlipped ? 'rotate(180deg)' : 'rotate(0deg)';
        
        // Rotacionar peças para manter orientação correta
        document.querySelectorAll('.piece').forEach(piece => {
            piece.style.transform = this.isFlipped ? 'rotate(180deg)' : 'rotate(0deg)';
        });

        // Inverter coordenadas se necessário
        const coordsElements = document.querySelectorAll('.coordinates-external');
        coordsElements.forEach(coord => {
            coord.style.transform = this.isFlipped ? 'rotate(180deg)' : 'rotate(0deg)';
        });
    }

    setPosition(fen) {
        // Implementação simplificada para demonstração
        console.log("Definindo posição FEN:", fen);
        // Em uma implementação real, você analisaria a string FEN e atualizaria o tabuleiro
    }

    highlightMove(from, to) {
        // Limpar destaques anteriores
        document.querySelectorAll('.last-move').forEach(square => {
            square.classList.remove('last-move');
        });

        // Adicionar novos destaques
        const fromSquare = document.querySelector(`[data-square="${from}"]`);
        const toSquare = document.querySelector(`[data-square="${to}"]`);

        if (fromSquare) fromSquare.classList.add('last-move');
        if (toSquare) toSquare.classList.add('last-move');
    }
}

let currentGame = null;
let chessboard = null;

document.addEventListener('DOMContentLoaded', function() {
    initializePlayPage();
});

function initializePlayPage() {
    // Initialize empty chessboard
    chessboard = new ProfessionalChessboard('play-chessboard');
    
    // Configurar callback de movimento
    chessboard.onMove = handlePlayerMove;

    // Setup event listeners
    setupPlayPageEvents();
    
    // Update model display
    updateModelDisplay();
}

function setupPlayPageEvents() {
    // Model selection
    document.getElementById('opponent-model')?.addEventListener('change', updateModelDisplay);
    
    // Color selection
    document.querySelectorAll('input[name="player-color"]').forEach(radio => {
        radio.addEventListener('change', updateColorDisplay);
    });
    
    // Difficulty selection
    document.getElementById('difficulty')?.addEventListener('change', updateDifficulty);
    
    // Time control selection
    document.getElementById('time-control')?.addEventListener('change', updateTimeControl);
    
    // Board controls
    document.querySelectorAll('[data-move]').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.move;
            handleMoveNavigation(action);
        });
    });
    
    // Start game button
    document.querySelector('[data-action="start-human-game"]')?.addEventListener('click', startNewGame);
    
    // Game controls
    document.querySelectorAll('.card button').forEach(btn => {
        if (btn.textContent.includes('Solicitar Dica')) {
            btn.addEventListener('click', requestHint);
        } else if (btn.textContent.includes('Desfazer Lance')) {
            btn.addEventListener('click', undoMove);
        } else if (btn.textContent.includes('Oferecer Empate')) {
            btn.addEventListener('click', offerDraw);
        } else if (btn.textContent.includes('Resignar')) {
            btn.addEventListener('click', resign);
        }
    });
}

function updateModelDisplay() {
    const modelSelect = document.getElementById('opponent-model');
    const modelName = modelSelect?.value || 'Gemini-Pro';
    
    // Update AI model display
    const aiModelDisplay = document.getElementById('ai-model-display');
    if (aiModelDisplay) {
        aiModelDisplay.textContent = modelName;
    }
    
    // Update AI rating based on model
    const aiRating = document.getElementById('ai-rating');
    if (aiRating) {
        const ratings = {
            'GPT-4o': 1850,
            'GPT-4-Turbo': 1780,
            'Gemini-Pro': 1750,
            'Claude-3.5-Sonnet': 1820,
            'Deepseek-R1': 1680
        };
        aiRating.textContent = ratings[modelName] || 1750;
    }
}

function updateColorDisplay() {
    const playerColor = document.querySelector('input[name="player-color"]:checked')?.value || 'white';
    const aiColor = playerColor === 'white' ? 'black' : 'white';
    
    // Update displays
    const playerColorDisplay = document.getElementById('player-color-display');
    const aiColorDisplay = document.getElementById('ai-color-display');
    
    if (playerColorDisplay) {
        playerColorDisplay.textContent = playerColor === 'white' ? 'Brancas' : 'Pretas';
    }
    
    if (aiColorDisplay) {
        aiColorDisplay.textContent = aiColor === 'white' ? 'Brancas' : 'Pretas';
    }
    
    // Flip board if playing as black
    if (chessboard) {
        chessboard.config.flipped = playerColor === 'black';
        chessboard.flip();
    }
}

function updateDifficulty() {
    const difficulty = document.getElementById('difficulty')?.value || 'advanced';
    
    // Update player rating based on difficulty
    const playerRating = document.getElementById('player-rating');
    if (playerRating) {
        const ratings = {
            'beginner': 1200,
            'intermediate': 1400,
            'advanced': 1600,
            'expert': 1800,
            'master': 2000
        };
        playerRating.textContent = ratings[difficulty] || 1600;
    }
}

function updateTimeControl() {
    const timeControl = document.getElementById('time-control')?.value || 'blitz';
    
    // Update time control display
    const display = document.getElementById('time-control-display');
    if (display) {
        const controls = {
            'unlimited': 'Sem Limite',
            'bullet': 'Bullet 1+0',
            'blitz': 'Blitz 5+3',
            'rapid': 'Rapid 15+10',
            'classical': 'Classical 30+0'
        };
        display.textContent = controls[timeControl] || 'Blitz 5+3';
    }
    
    // Update clock displays
    const times = {
        'unlimited': '∞',
        'bullet': '1:00',
        'blitz': '5:00',
        'rapid': '15:00',
        'classical': '30:00'
    };
    
    const time = times[timeControl] || '5:00';
    document.getElementById('player-time').textContent = time;
    document.getElementById('ai-time').textContent = time;
}

async function startNewGame() {
    try {
        // Show loading
        if (window.arena) {
            window.arena.showLoading('Iniciando partida...');
        }
        
        // Get game configuration
        const config = {
            opponentModel: document.getElementById('opponent-model')?.value || 'Gemini-Pro',
            playerColor: document.querySelector('input[name="player-color"]:checked')?.value || 'white',
            difficulty: document.getElementById('difficulty')?.value || 'advanced',
            timeControl: document.getElementById('time-control')?.value || 'blitz'
        };
        
        // Start game via API
        if (window.smartAPI) {
            currentGame = await window.smartAPI.startHumanGame(config);
        }
        
        // Update UI
        updateGameStatus('playing', 'Sua vez de jogar');
        
        // Enable board interaction
        if (chessboard) {
            chessboard.config.interactive = true;
            chessboard.updateConfig({ interactive: true });
        }
        
        // Show board controls
        document.getElementById('board-controls').style.display = 'flex';
        
        // Enable game controls
        document.querySelectorAll('.card button').forEach(btn => {
            if (!btn.textContent.includes('Iniciar Partida')) {
                btn.disabled = false;
            }
        });
        
        // Initialize move history
        updateMoveHistory([]);
        
        // Start clocks if needed
        if (config.timeControl !== 'unlimited') {
            startGameClock();
        }
        
        if (window.arena) {
            window.arena.hideLoading();
            window.arena.showToast('Partida iniciada! Faça seu lance.', 'success');
        }
        
    } catch (error) {
        console.error('Error starting game:', error);
        if (window.arena) {
            window.arena.hideLoading();
            window.arena.showToast('Erro ao iniciar partida', 'error');
        }
    }
}

function handlePlayerMove(move) {
    if (!currentGame || !isPlayerTurn) return;
    
    console.log("Jogador moveu:", move);
    
    if (window.smartAPI) {
        window.smartAPI.makeMove(currentGame.id, move.from + move.to)
            .then(response => {
                // Update move history
                updateMoveHistory(response.history || []);
                
                // Check for game end
                if (response.gameOver) {
                    endGame(response.result);
                }
            })
            .catch(error => {
                console.error('Move error:', error);
                if (window.arena) {
                    window.arena.showToast('Lance inválido', 'warning');
                }
            });
    }
}

function updateGameStatus(status, message) {
    const statusElement = document.getElementById('game-status');
    if (statusElement) {
        // Remover classes de status anteriores
        statusElement.className = 'game-status';
        
        // Adicionar nova classe de status
        statusElement.classList.add(`status-${status}`);
        
        // Atualizar texto
        statusElement.innerHTML = `
            <i class="fas fa-${status === 'playing' ? 'play' : 
                              status === 'check' ? 'exclamation-triangle' : 
                              status === 'checkmate' ? 'flag' : 
                              status === 'draw' ? 'handshake' : 'info-circle'}"></i>
            ${message}
        `;
    }
}

function updateMoveHistory(moves) {
    const historyElement = document.getElementById('move-history');
    if (!historyElement) return;
    
    if (moves.length === 0) {
        historyElement.innerHTML = `
            <div style="color: var(--text-muted); text-align: center; padding: 20px; font-style: italic;">
                Nenhuma partida em andamento
            </div>
        `;
        return;
    }
    
    let html = '';
    for (let i = 0; i < moves.length; i += 2) {
        const moveNumber = Math.floor(i / 2) + 1;
        const whiteMove = moves[i] || '';
        const blackMove = moves[i + 1] || '';
        
        html += `
            <div style="padding: 4px 8px; border-bottom: 1px solid var(--border-color);">
                <span style="color: var(--text-secondary); width: 20px; display: inline-block;">${moveNumber}.</span>
                <span style="margin-right: 12px;">${whiteMove}</span>
                <span>${blackMove}</span>
            </div>
        `;
    }
    
    historyElement.innerHTML = html;
    historyElement.scrollTop = historyElement.scrollHeight;
}

function handleMoveNavigation(action) {
    // Navigate through move history
    console.log(`Move navigation: ${action}`);
}

function requestHint() {
    if (window.arena) {
        window.arena.showToast('Dica: Considere desenvolver suas peças!', 'info');
    }
}

function undoMove() {
    console.log('Undo move requested');
}

function offerDraw() {
    if (confirm('Oferecer empate ao oponente?')) {
        console.log('Draw offered');
    }
}

function resign() {
    if (confirm('Tem certeza que deseja resignar?')) {
        endGame('0-1', 'Você resignou');
    }
}

function startGameClock() {
    // Implement game clock logic
    console.log('Game clock started');
}

function endGame(result, reason = '') {
    // Show game result modal
    const modal = document.getElementById('game-result-modal');
    const resultText = document.getElementById('result-text');
    const resultReason = document.getElementById('result-reason');
    const resultIcon = document.getElementById('result-icon');
    
    if (modal && resultText && resultIcon) {
        // Determine result message
        let message = '';
        let icon = '';
        
        if (result === '1-0') {
            message = 'Você venceu!';
            icon = '🏆';
        } else if (result === '0-1') {
            message = 'Você perdeu!';
            icon = '😔';
        } else {
            message = 'Empate!';
            icon = '🤝';
        }
        
        resultText.textContent = message;
        resultIcon.textContent = icon;
        
        if (resultReason) {
            resultReason.textContent = reason || 'Fim de jogo';
        }
        
        modal.style.display = 'flex';
    }
    
    // Disable game controls
    document.querySelectorAll('.card button').forEach(btn => {
        if (!btn.textContent.includes('Nova Partida')) {
            btn.disabled = true;
        }
    });
    
    currentGame = null;
}

function closeGameResultModal() {
    const modal = document.getElementById('game-result-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Export functions for global access
window.startNewGame = startNewGame;
window.closeGameResultModal = closeGameResultModal;
</script>