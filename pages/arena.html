<!-- ♟️ Dashboard Principal Simplificado -->
<div class="text-center mb-32">
    <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">
        <i class="fas fa-chess" style="color: var(--lichess-brown-light);"></i>
        LLM Chess Arena
    </h1>
    <p style="color: var(--text-secondary); font-size: 16px;">
        Arena de xadrez entre modelos de IA com visualização em tempo real
    </p>
</div>

<!-- Métricas Principais -->
<div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div class="metric-card">
        <div class="metric-icon" style="background: var(--lichess-blue);">
            <i class="fas fa-chess"></i>
        </div>
        <div class="metric-content">
            <div id="total-games" class="metric-value">0</div>
            <div class="metric-label">Total de Partidas</div>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-icon" style="background: var(--lichess-green);">
            <i class="fas fa-robot"></i>
        </div>
        <div class="metric-content">
            <div id="active-models" class="metric-value">0</div>
            <div class="metric-label">Modelos Ativos</div>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-icon" style="background: var(--lichess-orange);">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div id="avg-moves" class="metric-value">0</div>
            <div class="metric-label">Lances por Partida</div>
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-icon" style="background: var(--lichess-purple);">
            <i class="fas fa-play"></i>
        </div>
        <div class="metric-content">
            <div id="active-games" class="metric-value">0</div>
            <div class="metric-label">Jogos Ativos</div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="d-grid" style="grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-swords"></i>
                Iniciar Batalha
            </h3>
        </div>
        
        <div class="form-group">
            <label class="form-label">Modelo 1 (Brancas)</label>
            <select class="form-control" id="quick-white-model">
                <option value="">Carregando modelos...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Modelo 2 (Pretas)</label>
            <select class="form-control" id="quick-black-model">
                <option value="">Carregando modelos...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Abertura</label>
            <select class="form-control" id="quick-opening">
                <option value="e4">1.e4 (King's Pawn)</option>
                <option value="d4">1.d4 (Queen's Pawn)</option>
                <option value="Nf3">1.Nf3 (Réti Opening)</option>
                <option value="c4">1.c4 (English Opening)</option>
                <option value="g3">1.g3 (Benko Opening)</option>
            </select>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="startQuickBattle()">
            <i class="fas fa-play"></i>
            Iniciar Batalha
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-gamepad"></i>
                Jogar contra IA
            </h3>
        </div>
        
        <div class="form-group">
            <label class="form-label">Oponente</label>
            <select class="form-control" id="human-opponent">
                <option value="">Carregando modelos...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Sua Cor</label>
            <div class="d-flex gap-8">
                <label class="form-check" style="flex: 1; text-align: center;">
                    <input type="radio" name="human-color" value="white" checked>
                    <span>♔ Brancas</span>
                </label>
                <label class="form-check" style="flex: 1; text-align: center;">
                    <input type="radio" name="human-color" value="black">
                    <span>♚ Pretas</span>
                </label>
            </div>
        </div>
        
        <button class="btn btn-success" style="width: 100%; justify-content: center;" onclick="startHumanGame()">
            <i class="fas fa-user"></i>
            Jogar Agora
        </button>
    </div>
</div>

<!-- Jogo Ativo ou Histórico -->
<div class="d-grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
    <!-- Partida Ativa -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-eye"></i>
                Partida em Andamento
            </h3>
            <div id="game-status-badge" class="badge badge-secondary">Nenhuma partida ativa</div>
        </div>
        
        <div id="active-game-display">
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-chess-board" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>Nenhuma partida ativa no momento</p>
                <p style="font-size: 14px;">Inicie uma batalha para ver a partida aqui</p>
            </div>
        </div>
    </div>

    <!-- Histórico Recente -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-history"></i>
                Partidas Recentes
            </h3>
            <button class="btn btn-sm btn-secondary" onclick="loadRecentGames()">
                <i class="fas fa-sync"></i>
                Atualizar
            </button>
        </div>
        
        <div id="recent-games-list" style="max-height: 300px; overflow-y: auto;">
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                <p>Carregando partidas...</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabuleiro para Visualização da Partida Ativa -->
<div id="live-game-board" class="card" style="display: none; margin-top: 24px;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chess-board"></i>
            <span id="live-game-title">Partida Ao Vivo</span>
        </h3>
        <div class="d-flex gap-8">
            <span id="live-game-turn" class="badge badge-primary">Vez das brancas</span>
            <span id="live-game-moves" class="badge badge-secondary">Lance 1</span>
        </div>
    </div>
    
    <div class="d-grid" style="grid-template-columns: auto 1fr; gap: 24px; align-items: start;">
        <!-- Tabuleiro -->
        <div class="chessboard-wrapper">
            <div id="live-chessboard" style="width: 400px; height: 400px; border: 2px solid var(--border-color); border-radius: var(--border-radius);"></div>
        </div>
        
        <!-- Informações da Partida -->
        <div>
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header" style="padding: 12px 16px;">
                    <h4 style="margin: 0; font-size: 16px;">Jogadores</h4>
                </div>
                <div style="padding: 16px;">
                    <div class="d-flex justify-between align-center" style="margin-bottom: 12px;">
                        <div class="d-flex align-center gap-8">
                            <span style="font-size: 20px;">♔</span>
                            <span id="white-player-name" style="font-weight: 600;">-</span>
                        </div>
                        <div id="white-thinking" style="display: none; color: var(--lichess-blue);">
                            <i class="fas fa-brain fa-pulse"></i> Pensando...
                        </div>
                    </div>
                    <div class="d-flex justify-between align-center">
                        <div class="d-flex align-center gap-8">
                            <span style="font-size: 20px;">♚</span>
                            <span id="black-player-name" style="font-weight: 600;">-</span>
                        </div>
                        <div id="black-thinking" style="display: none; color: var(--lichess-blue);">
                            <i class="fas fa-brain fa-pulse"></i> Pensando...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header" style="padding: 12px 16px;">
                    <h4 style="margin: 0; font-size: 16px;">Histórico de Lances</h4>
                </div>
                <div id="live-move-history" style="padding: 16px; max-height: 200px; overflow-y: auto; font-family: var(--font-mono); font-size: 14px;">
                    <div style="color: var(--text-muted); text-align: center;">Aguardando lances...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard Principal
let socket = null;
let liveBoard = null;
let currentGameId = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
});

async function initializeDashboard() {
    console.log('🎮 Inicializando Dashboard...');
    
    // Conectar WebSocket
    initializeSocket();
    
    // Carregar dados iniciais
    await loadDashboardData();
    
    // Carregar modelos disponíveis
    await loadAvailableModels();
    
    // Atualizar dados a cada 30 segundos
    setInterval(loadDashboardData, 30000);
    
    console.log('✅ Dashboard inicializado');
}

function initializeSocket() {
    socket = io();
    
    socket.on('connect', () => {
        console.log('🔌 Conectado ao servidor');
        showToast('Conectado ao servidor', 'success');
    });
    
    socket.on('disconnect', () => {
        console.log('🔌 Desconectado do servidor');
        showToast('Desconectado do servidor', 'warning');
    });
    
    // Escutar atualizações de jogo em tempo real
    socket.on('game-update', (data) => {
        handleGameUpdate(data);
    });
    
    socket.on('model-thinking', (data) => {
        showModelThinking(data.model, data.color);
    });
    
    socket.on('game-finished', (data) => {
        handleGameFinished(data);
    });
    
    socket.on('game-error', (data) => {
        showToast(`Erro no jogo: ${data.error}`, 'error');
        hideActiveGame();
    });
}

async function loadDashboardData() {
    try {
        const [stats, recentGames] = await Promise.all([
            fetch('/api/games/stats').then(r => r.json()),
            fetch('/api/games/recent?limit=5').then(r => r.json())
        ]);
        
        updateMetrics(stats);
        updateRecentGames(recentGames);
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showToast('Erro ao carregar dados do dashboard', 'error');
    }
}

function updateMetrics(stats) {
    animateNumber(document.getElementById('total-games'), stats.totalGames || 0);
    animateNumber(document.getElementById('active-models'), stats.activeModels || 0);
    animateNumber(document.getElementById('avg-moves'), stats.avgMoves || 0);
    animateNumber(document.getElementById('active-games'), stats.activeGames || 0);
}

function animateNumber(element, targetValue) {
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000;
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
        element.textContent = currentValue;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

async function loadAvailableModels() {
    try {
        const models = await fetch('/api/models/available').then(r => r.json());
        
        updateModelSelectors(models);
        
    } catch (error) {
        console.error('Erro ao carregar modelos:', error);
    }
}

function updateModelSelectors(models) {
    const selectors = ['quick-white-model', 'quick-black-model', 'human-opponent'];
    
    selectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione um modelo...</option>';
        
        Object.entries(models).forEach(([name, config]) => {
            if (config.active) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (ELO: ${config.elo})`;
                select.appendChild(option);
            }
        });
    });
}

function updateRecentGames(games) {
    const container = document.getElementById('recent-games-list');
    if (!container) return;
    
    if (!games || games.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                <p>Nenhuma partida encontrada</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = games.map(game => `
        <div class="game-item" style="padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="viewGame('${game.id}')">
            <div class="d-flex justify-between align-center">
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">
                        ${game.white} vs ${game.black}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        ${game.moves} lances • ${game.date}
                    </div>
                </div>
                <div class="game-result" style="font-weight: 700; padding: 4px 8px; border-radius: 4px; background: var(--bg-tertiary);">
                    ${game.result}
                </div>
            </div>
        </div>
    `).join('');
}

async function startQuickBattle() {
    const whiteModel = document.getElementById('quick-white-model').value;
    const blackModel = document.getElementById('quick-black-model').value;
    const opening = document.getElementById('quick-opening').value;
    
    if (!whiteModel || !blackModel) {
        showToast('Selecione ambos os modelos', 'warning');
        return;
    }
    
    if (whiteModel === blackModel) {
        showToast('Selecione modelos diferentes', 'warning');
        return;
    }
    
    try {
        showToast('Iniciando batalha...', 'info');
        
        const response = await fetch('/api/games/battle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                whiteModel,
                blackModel, 
                opening
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Batalha iniciada! Acompanhe abaixo.', 'success');
            
            // Preparar interface para partida ativa
            prepareActiveGame(whiteModel, blackModel);
            
        } else {
            showToast('Erro ao iniciar batalha', 'error');
        }
        
    } catch (error) {
        console.error('Erro na batalha:', error);
        showToast('Erro de conexão', 'error');
    }
}

function prepareActiveGame(whiteModel, blackModel) {
    // Mostrar tabuleiro ao vivo
    const liveBoardDiv = document.getElementById('live-game-board');
    liveBoardDiv.style.display = 'block';
    
    // Atualizar título
    document.getElementById('live-game-title').textContent = `${whiteModel} vs ${blackModel}`;
    document.getElementById('white-player-name').textContent = whiteModel;
    document.getElementById('black-player-name').textContent = blackModel;
    
    // Atualizar status
    document.getElementById('game-status-badge').textContent = 'Partida Ativa';
    document.getElementById('game-status-badge').className = 'badge badge-success';
    
    // Inicializar tabuleiro se necessário
    if (!liveBoard) {
        initializeLiveBoard();
    }
    
    // Limpar histórico
    document.getElementById('live-move-history').innerHTML = '<div style="color: var(--text-muted); text-align: center;">Aguardando lances...</div>';
    
    // Scroll para o tabuleiro
    liveBoardDiv.scrollIntoView({ behavior: 'smooth' });
}

function initializeLiveBoard() {
    const boardElement = document.getElementById('live-chessboard');
    if (!boardElement) return;
    
    // Criar tabuleiro visual simples
    boardElement.innerHTML = '';
    boardElement.className = 'chess-board';
    
    for (let rank = 8; rank >= 1; rank--) {
        for (let file = 0; file < 8; file++) {
            const square = document.createElement('div');
            const fileChar = String.fromCharCode(97 + file);
            const squareId = `${fileChar}${rank}`;
            
            const isLight = (rank + file) % 2 !== 0;
            square.className = `chess-square ${isLight ? 'light' : 'dark'}`;
            square.dataset.square = squareId;
            square.style.width = '12.5%';
            square.style.height = '12.5%';
            square.style.display = 'inline-block';
            square.style.position = 'relative';
            
            boardElement.appendChild(square);
        }
    }
    
    // Adicionar peças iniciais
    setupInitialPieces();
    liveBoard = true;
}

function setupInitialPieces() {
    const initialPosition = {
        'a8': '♜', 'b8': '♞', 'c8': '♝', 'd8': '♛', 'e8': '♚', 'f8': '♝', 'g8': '♞', 'h8': '♜',
        'a7': '♟', 'b7': '♟', 'c7': '♟', 'd7': '♟', 'e7': '♟', 'f7': '♟', 'g7': '♟', 'h7': '♟',
        'a2': '♙', 'b2': '♙', 'c2': '♙', 'd2': '♙', 'e2': '♙', 'f2': '♙', 'g2': '♙', 'h2': '♙',
        'a1': '♖', 'b1': '♘', 'c1': '♗', 'd1': '♕', 'e1': '♔', 'f1': '♗', 'g1': '♘', 'h1': '♖'
    };
    
    Object.entries(initialPosition).forEach(([square, piece]) => {
        const squareElement = document.querySelector(`[data-square="${square}"]`);
        if (squareElement) {
            squareElement.innerHTML = `<span style="font-size: 28px; line-height: 1; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">${piece}</span>`;
        }
    });
}

function handleGameUpdate(data) {
    currentGameId = data.gameId;
    
    // Atualizar informações da partida
    document.getElementById('live-game-moves').textContent = `Lance ${data.currentMove}`;
    document.getElementById('live-game-turn').textContent = data.turn === 'w' ? 'Vez das brancas' : 'Vez das pretas';
    document.getElementById('live-game-turn').className = `badge badge-${data.turn === 'w' ? 'primary' : 'secondary'}`;
    
    // Atualizar histórico de lances
    updateLiveMoveHistory(data.history);
    
    // Atualizar tabuleiro (simulado - em produção usaria uma biblioteca como chessboard.js)
    if (data.fen) {
        updateBoardFromFEN(data.fen);
    }
    
    // Esconder indicadores de pensamento
    hideAllThinking();
}

function updateLiveMoveHistory(history) {
    const container = document.getElementById('live-move-history');
    if (!container || !history.length) return;
    
    let html = '';
    for (let i = 0; i < history.length; i += 2) {
        const moveNumber = Math.floor(i / 2) + 1;
        const whiteMove = history[i] || '';
        const blackMove = history[i + 1] || '';
        
        html += `
            <div style="margin-bottom: 4px;">
                <span style="color: var(--text-secondary); width: 30px; display: inline-block;">${moveNumber}.</span>
                <span style="margin-right: 16px; font-weight: 600;">${whiteMove}</span>
                <span style="font-weight: 600;">${blackMove}</span>
            </div>
        `;
    }
    
    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

function showModelThinking(model, color) {
    const thinkingElement = document.getElementById(`${color === 'white' ? 'white' : 'black'}-thinking`);
    if (thinkingElement) {
        thinkingElement.style.display = 'block';
    }
}

function hideAllThinking() {
    document.getElementById('white-thinking').style.display = 'none';
    document.getElementById('black-thinking').style.display = 'none';
}

function handleGameFinished(data) {
    hideAllThinking();
    
    // Atualizar status
    document.getElementById('game-status-badge').textContent = 'Partida Finalizada';
    document.getElementById('game-status-badge').className = 'badge badge-secondary';
    
    showToast(`Partida finalizada: ${data.result} - ${data.resultReason}`, 'info', 8000);
    
    // Recarregar dados
    setTimeout(() => {
        loadDashboardData();
        hideActiveGame();
    }, 5000);
}

function hideActiveGame() {
    setTimeout(() => {
        document.getElementById('live-game-board').style.display = 'none';
        currentGameId = null;
    }, 10000);
}

function updateBoardFromFEN(fen) {
    // Implementação simplificada - em produção usaria chessboard.js
    console.log('Atualizando tabuleiro:', fen);
}

async function startHumanGame() {
    const opponent = document.getElementById('human-opponent').value;
    const color = document.querySelector('input[name="human-color"]:checked').value;
    
    if (!opponent) {
        showToast('Selecione um oponente', 'warning');
        return;
    }
    
    // Redirecionar para página de jogo
    showToast('Redirecionando para jogo...', 'info');
    
    // Em uma implementação real, mudaria para a página de jogo
    setTimeout(() => {
        window.location.hash = '#play';
        showToast('Funcionalidade em desenvolvimento', 'warning');
    }, 1000);
}

async function loadRecentGames() {
    showToast('Atualizando partidas...', 'info');
    await loadDashboardData();
    showToast('Partidas atualizadas', 'success');
}

function viewGame(gameId) {
    showToast(`Visualizando jogo ${gameId}`, 'info');
    // Em uma implementação real, abriria o visualizador de jogos
}

// Função utilitária para toasts
function showToast(message, type = 'info', duration = 3000) {
    const container = getToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${getToastIcon(type)}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function getToastContainer() {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 8px;';
        document.body.appendChild(container);
    }
    return container;
}

function getToastIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-circle', 
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Exportar funções globais
window.startQuickBattle = startQuickBattle;
window.startHumanGame = startHumanGame;
window.loadRecentGames = loadRecentGames;
window.viewGame = viewGame;
</script>

<style>
/* Estilos específicos do dashboard */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.metric-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.metric-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.chess-board {
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 0;
    line-height: 0;
}

.chess-square {
    box-sizing: border-box;
    position: relative;
}

.chess-square.light {
    background-color: #f0d9b5;
}

.chess-square.dark {
    background-color: #b58863;
}

.game-item:hover {
    background: var(--bg-tertiary);
}

.toast {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 200px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast.toast-success {
    border-left: 4px solid var(--lichess-green);
}

.toast.toast-error {
    border-left: 4px solid var(--lichess-red);
}

.toast.toast-warning {
    border-left: 4px solid var(--lichess-orange);
}

.toast.toast-info {
    border-left: 4px solid var(--lichess-blue);
}

.fa-pulse {
    animation: fa-pulse 1s infinite;
}

@keyframes fa-pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
}
</style>